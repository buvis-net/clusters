---
name: Update k3s in production

on:
  workflow_dispatch:
  schedule:
  - cron: "05 * * * *"

jobs:
  components:
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v3
    - name: Update k3s
      id: update
      run: |
        VERSION=$(curl -s https://update.k3s.io/v1-release/channels | jq --raw-output '.data[] | select(.name | test("stable")) | .latest')
        sed -i -r "s/k3s_version: \"(.*)\"/k3s_version: \"${version}\"/g" ./production/infrastructure/ansible/group_vars/all/all.yaml
        echo "::set-output name=k3s_version::$VERSION"
    - name: Create pull request for k3s update
      uses: peter-evans/create-pull-request@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: "k3s/update-${{ steps.update.outputs.k3s_version }}"
        delete-branch: true
        title: "Update k3s to ${{ steps.update.outputs.k3s_version }} in production"
        signoff: true
        committer: "${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
        author: "${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
        assignees: "tbouska"
        commit-message: "Update k3s components to ${{ steps.update.outputs.k3s_version }} in production"
        body: |
          Don't forget to run `buvis-upgrade` when you are back home!

          Release notes: https://github.com/k3s-io/k3s/releases/tag/${{ steps.update.outputs.k3s_version }}
        labels: k3s/update
